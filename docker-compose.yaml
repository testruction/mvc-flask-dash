version: "3.9"  # optional since v1.27.0

services:
  mysql:
    image: docker.io/amd64/mysql:8
    restart: always
    hostname: mysql
    environment:
      MYSQL_USER: ${MYSQL_USER:-mysql}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-password}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-mysql}
    ports:
      - "${MYSQL_PORT:-3306}:3306"

  jaeger:
    image: quay.io/jaegertracing/all-in-one:latest
    restart: always
    environment:
      LOG_LEVEL: debug
      COLLECTOR_OTLP_ENABLED: 'true'
    ports:
      - "${JARGER_WEBUI_PORT:-16686}:16686"
      - "${OTLP_EXPORTER_PORT:-4317}:4317"

  web:
    build:
      context: .
      # args:
      #   IMAGE_VERSION: ${TAG}-${BUILD_ID}
    image: image.local/testruction/mvc-flask-dash
    command: tail -f /dev/null
    ports:
      - "55000:5000"
    environment:
      # Flask
      FLASK_RUN_HOST: 0.0.0.0
      FLASK_RUN_PORT: 5000
      # OTLP GRPC
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4317
      OTEL_EXPORTER_OTLP_INSECURE: "true"
      # MySQL
      MYSQL_HOST: mysql
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_USER: ${MYSQL_USER:-mysql}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-password}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-mysql}
    links:
      - jaeger
      - mysql
    volumes:
      - ./src:/app/src
      - ./tests:/app/tests
      - ./MANIFEST.in:/app/MANIFEST.in
      - ./pyproject.toml:/app/pyproject.toml
      - ./README.md:/app/README.md
      - ./setup.cfg:/app/setup.cfg
      - ./VERSION:/app/VERSION
